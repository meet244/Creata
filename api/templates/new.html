<!DOCTYPE html>
<html>
<head>
  <title>Generate</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
  <style>

    /* For WebKit-based browsers (e.g., Chrome, Safari) */
    ::-webkit-scrollbar {
      width: 12px;
    }

    ::-webkit-scrollbar-track {
      background-color: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background-color: rgb(10, 201, 96);
      border-radius: 6px;
    }

    /* For Microsoft Edge and Internet Explorer */
    /* Note: Internet Explorer does not support customizing the scrollbar */
    /* These properties will only affect Microsoft Edge (EdgeHTML engine) */
    /* The thumb styling will still be applied */
    @supports (-ms-overflow-style: none) {
      /* Remove the default scrollbar */
      ::-ms-scrollbar {
        width: 0;
        height: 0;
      }

      /* Style the thumb */
      ::-ms-scrollbar-thumb {
        background-color: rgb(10, 201, 96);
        border-radius: 6px;
      }
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      grid-gap: 10px;
    }

    .grid-item {
      position: relative;
      display: inline-block;
      justify-self: center;
      width: 260px; /* Adjust the width as needed */
      margin: 10px; /* Adjust the margin as needed */
    }

    .grid-item img {
      border-radius: 15px;
      max-width: 100%;
      max-height: 100%;
      transition: filter 0.3s, transform 0.3s;
    }

    .grid-item:hover img {
      filter: brightness(70%);
      transform: scale(1.05);
      cursor: pointer;
    }

    .material-symbols-outlined {
      cursor: pointer;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #fff;
      font-size: 48px;
      opacity: 0;
      transition: opacity 0.3s;
      font-variation-settings: 'opsz' 48, 'wght' 400, 'FILL' 0, 'GRAD' 0;
    }

    .grid-item:hover .material-symbols-outlined {
      opacity: 1;
    }

    .button-container {
      text-align: center;
      margin-bottom: 20px;
    }

    button {
      background-color: rgba(25, 88, 224, 0);
      border: 1px solid #ffffff;;
      color: white;
      padding: 9px 20px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
      /* font-family: 'Brush Script MT', cursive; */
      font-weight: bold;
    }

    .active {
      color: #ffffff;
      background-color: #4285F4;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .CancelButton{
      /* font-family: 'Brush Script MT', cursive; */
      display: inline-block;
      padding: 10px 20px;
      font-size: 16px;
      font-weight: bold;
      text-align: center;
      text-decoration: none;
      border-radius: 4px;
      background-color: #4CAF50;
      color: #000000;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .prompt-container {
      text-align: center;
      margin-bottom: 20px;
    }

    .prompt-container textarea {
      color: white;
      background-color: rgb(34,40,57);
      caret-color: white;
      display: block;
      margin: 0 auto 10px;
      padding: 10px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      width: 80%; /* Adjust the width as needed */
    }

    .spinner-container {
      text-align: center;
    }

    .spinner-select {
      border: none;
      color: white;
      background-color: rgb(34,40,57);
      caret-color: white;
      font-size: 16px;
      border-radius: 5px;
      padding: 8px;
    }

    #createButton {
      background-color: rgb(10, 201, 96);
      color: #000000;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    #deleteButton {
      background-color: rgb(247, 20, 20);
      color: #ffffff;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    #allButton {
      background-color: rgb(253, 165, 1);
      color: #000000;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    #loadButton {
      background-color: rgb(255, 187, 0);
      color: #000000;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    #loadButton:hover {
      background-color: rgb(255, 115, 0);
    }

    #inputThreads {
      border: none;
      color: white;
      background-color: rgb(34,40,57);
      caret-color: white;
      font-size: 16px;
      padding: 8px;
      border-radius: 5px;
      margin-right: 10px;
      width: 100px;
    }

    .auto-resize {
      overflow: hidden;
      resize: none;
      min-height: 40px; /* Set a minimum height for the textarea */
    }

    .use-span {
      cursor: pointer;
      position: absolute;
      bottom: -25px; /* Adjust the distance from the bottom as needed */
      left: 0;
      opacity: 1;
      /* font-family: 'Brush Script MT', cursive; */
      width: 100%;
      text-align: center;
      color: #fff; /* Adjust the text color as needed */
      padding: 5px 0; /* Adjust the padding as needed */
      font-size: 14px; /* Adjust the font size as needed */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-height: 2em;
      transition: max-height 0.3s ease;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.75); /* Adjust the background color and opacity as needed */
      z-index: 9998; /* Adjust the z-index as needed */
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .highlighted-image {
      max-width: 90vw;
      max-height: 90vh;
      z-index: 9999; /* Adjust the z-index as needed */
    }

    .toast-container{
      color:#ffffff;
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1;
    }

    .toast{
      background-color: #4285F4;
      font-size: 16px;
      /* font-family: 'Brush Script MT', cursive; */
      padding: 16px;
      border-radius: 8px;
      margin: 2px;
    }

    /* Mobile Styles */
@media (max-width: 1080px) {
  .grid {
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  }

  .grid-item {
    display: flex;
    justify-items: center;
    justify-content: center;
    width: 300px;
    height: 300px;
    margin: 25px;
  }

  .grid-item img {
    border-radius: 20px;
    max-width: 100%;
    max-height: 100%;
    transition: filter 0.3s, transform 0.3s;
  }

  .grid-item:hover img {
    cursor: pointer;
  }

  .material-symbols-outlined {
    cursor: pointer;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #fff;
    font-size: 40px;
    opacity: 0;
    transition: opacity 0.3s;
    font-variation-settings: 'opsz' 40, 'wght' 400, 'FILL' 0, 'GRAD' 0;
  }

  .grid-item:hover .material-symbols-outlined {
    opacity: 1;
  }

  .button-container {
    text-align: center;
    margin-bottom: 30px;
  }

  button {
    background-color: rgba(25, 88, 224, 0);
    border: 1px solid #ffffff;
    color: white;
    padding: 12px 24px;
    font-size: 18px;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s;
    /* font-family: 'Brush Script MT', cursive; */
    font-weight: bold;
  }

  .active {
    color: #ffffff;
    background-color: #4285F4;
    padding: 12px 24px;
    font-size: 40px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s;
  }

  .CancelButton {
    font-family: 'Brush Script MT', cursive;
    display: inline-block;
    padding: 12px 24px;
    font-size: 18px;
    font-weight: bold;
    text-align: center;
    text-decoration: none;
    border-radius: 6px;
    background-color: #4CAF50;
    color: #000000;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s;
  }

  .prompt-container textarea {
    font-size: 40px;
    width: 100%;
    width: 95vw;
  }

  #inputThreads {
    width: 100px;
    font-size: 40px;
    margin: 10px;
  }

  .use-span{
    font-size: 30px;
    bottom: -50px;
  }

  .spinner-select{
    font-size: 40px;
  }

  #allButton, #createButton, #loadButton, #deleteButton{
    font-size: 40px;
  }
  
  button{
    margin: 10px;
    font-size: 40px;
  }

  .toast{
    font-size: 40px;
  }
}
  </style>
</head>
<body style="background-color: #12151E;overflow-x: hidden;">
  <div id="toastContainer" class="toast-container"></div>
  <div class="button-container">
    <div class="prompt-container">
      <textarea id="promptInput" placeholder="Prompt" class="auto-resize"></textarea>
      <textarea id="negativePromptInput" placeholder="Negative Prompt" class="auto-resize"></textarea>
      <div class="spinner-container">
        <select id="spinnerSelect" class="spinner-select">
          <option value="art">art</option>
          <option value="drawing">drawing</option>
          <option value="photo">photo</option>
          <option value="none">none</option>
        </select>
        <input type="text" id="inputThreads" placeholder="Threads" inputmode="numeric" pattern="[0-9]*" />
        <button id="createButton" onclick="saveData()">Create</button>
        <button id="loadButton" onclick="loadData()">Refresh</button>
        <button id="deleteButton" onclick="Delete()">Delete All</button>
        <button id="allButton" onclick="DownloadOrUpscale()">Download All</button>
      </div>
    </div>
    <button id="generateButton" onclick="toggleMode('generate')">Generate</button>
    <button id="upscaleButton" onclick="toggleMode('upscale')">Upscale</button>
    <button id="upscaleButton" onclick="toUpload()">Upload</button>
  </div>

  <div class="grid" id="image-grid"></div>

  <script>
    // Get the textarea element
    const textarea = document.getElementById('promptInput');
    const textarea2 = document.getElementById('negativePromptInput');

    // Function to handle the textarea resize
    function handleTextareaResize() {
      textarea.style.height = 'auto'; // Reset the height to auto
      textarea.style.height = textarea.scrollHeight + 'px'; // Set the height to match the content
      textarea2.style.height = 'auto'; // Reset the height to auto
      textarea2.style.height = textarea2.scrollHeight + 'px'; // Set the height to match the content
    }

    // Add event listener for input or change events
    textarea.addEventListener('input', handleTextareaResize);
    textarea.addEventListener('change', handleTextareaResize);
    textarea2.addEventListener('input', handleTextareaResize);
    textarea2.addEventListener('change', handleTextareaResize);

    // Initial resize on page load
    window.addEventListener('load', handleTextareaResize);

    function saveData() {
      // Get the values from the input fields and select options
      const prompt = document.getElementById('promptInput').value;
      const negative = document.getElementById('negativePromptInput').value;
      const count = document.getElementById('inputThreads').value;
      const spinner = document.getElementById('spinnerSelect');
      const model = spinner.options[spinner.selectedIndex].value;

      // Construct the JSON payload
      const payload = {
        model: model,
        negative: negative,
        prompt: prompt,
        count: count
      };

      // Send the JSON payload as a POST request
      fetch(currentURL + '/save', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      })
        .then(response => {
          console.log('Data saved successfully');
          showPopup('Data saved successfully');
        })
        .catch(error => {
          console.error('Error:', error);
        });
    }

    function showPopup(message) {
      showToast(message);
    }

    function loadData() {
      fetch(currentURL + '/load')
        .then(response => response.json())
        .then(data => {
          for (const key in data) {
            if(key == 'prompt'){
              const textarea = document.getElementById('promptInput')
              textarea.value = data[key]
            }
            else if(key == 'negative'){
              const textarea = document.getElementById('negativePromptInput')
              textarea.value = data[key]
            }
            else if(key === 'count'){
              const textarea = document.getElementById('inputThreads')
              textarea.value = data[key]
            }
            else if(key == 'model'){
              const spinner = document.getElementById('spinnerSelect');
              const value = data[key]
              if (value === 'art') {
                spinner.selectedIndex = 0;
              } else if (value === 'drawing') {
                spinner.selectedIndex = 1;
              } else if (value === 'photo') {
                spinner.selectedIndex = 2;
              } else if (value === 'none') {
                spinner.selectedIndex = 3;
              } else {
                // Default selection if value doesn't match any options
                spinner.selectedIndex = 0;
              }
            }
          }
          handleTextareaResize()
          showPopup("updated")
        })
        .catch(error => {
          console.error('Error:', error);
        });
    }

    function toggleMode(m) {
      const generateButton = document.getElementById('generateButton');
      mode = m
      const upscaleButton = document.getElementById('upscaleButton');
      const imageGrid = document.getElementById('image-grid');

      if (mode === 'generate') {
        callTo = 'data'
        btn = document.getElementById('allButton');
        btn.innerText = 'Upscale All';
        generateButton.classList.add('active');
        upscaleButton.classList.remove('active');

        fetch('./data')
          .then(response => response.json())
          .then(data => {
            imageGrid.innerHTML = '';

            if (Array.isArray(data)) {
              data.reverse().forEach(url => {
                const gridItem = createGridItem(url,mode);
                imageGrid.appendChild(gridItem);
              });
            } 
            // else {
            //   Object.reverse().values(data).forEach(url => {
            //     const gridItem = createGridItem(url,mode);
            //     imageGrid.appendChild(gridItem);  
            //   });
            // }
            handleTextareaResize();
            if(repeatstart == false){
              repeatstart = true;
              RepeatCall();
            }
          })
          .catch(error => {
            console.error('Error:', error);
          });
      } else if (mode === 'upscale') {
        callTo = 'upgraded'
        btn = document.getElementById('allButton');
        btn.innerText = 'Download All';
        generateButton.classList.remove('active');
        upscaleButton.classList.add('active');

        fetch('./upgraded')
          .then(response => response.json())
          .then(data => {
            imageGrid.innerHTML = '';

            data.reverse().forEach(url => {
              const gridItem = createGridItem(url, mode);
              imageGrid.appendChild(gridItem);
            });
            handleTextareaResize();
            if(repeatstart == false){
              repeatstart = true;
              RepeatCall();
            }
          })
          .catch(error => {
            console.error('Error:', error);
          });
      }
    }

    function downloadImage(src){
      fetch(src)
        .then(response => response.blob())
        .then(blob => {
          const imageURL = URL.createObjectURL(blob);
          const downloadLink = document.createElement('a');
          downloadLink.href = imageURL;
          downloadLink.target = '_blank'; // Open in a new tab
          downloadLink.download = generateUUID() + '.png'; // Set a default file name if needed
          downloadLink.click();
        });
    }

    function createGridItem(url, mode) {
      const gridItem = document.createElement('div');
      gridItem.className = 'grid-item';

      const image = document.createElement('img');
      image.src = (mode === 'generate') ? "https://img.craiyon.com/" + url[0] : "https://pics.craiyon.com/" + url[0];

      const upgradeIcon = document.createElement('span');
      upgradeIcon.className = 'material-symbols-outlined';

      const span = document.createElement('span');
      span.className = "use-span";
      span.innerText = url[1] + " | " + url[2]; // Set the text before appending the button

      span.addEventListener('click', () => {
        document.getElementById('promptInput').value = url[2]
        document.getElementById('spinnerSelect').selectedIndex = value === 'art' ? 0 : value === 'drawing' ? 1 : value === 'photo' ? 2 : value === 'none' ? 3 : 0;
        handleTextareaResize()
      })

      if (mode === 'generate') {
        upgradeIcon.innerHTML = 'upgrade'; // Material Icon HTML entity code for "upgrade"
        image.addEventListener('click', () => {
          // Click function for generate mode
          // const promptInput = document.getElementById('promptInput');
          const promptInputNeg = document.getElementById('negativePromptInput');
          // const spin = document.getElementById('spinnerSelect');
          const count = document.getElementById('inputThreads');
          const requestBody = {
            image_id: url[0],
            prompt: url[2],
            version: '35s5hfwn9n78gb06',
            token: null,
            model: url[1],
            negative_prompt: promptInputNeg.value,
            count: count
          };

          fetch(currentURL + '/upgrade', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
          })
          .then(response => {
            // Handle the response as needed
            console.log('Upgrade request sent');
            gridItem.removeChild(image);
          })
          .catch(error => {
            console.error('Error:', error);
          });
        });

      } else if (mode === 'upscale') {
        upgradeIcon.innerHTML = 'zoom_in'; // Material Icon HTML entity code for "zoom_in"
        image.addEventListener('click', () => {
          // Click function for upscale mode
          const overlay = document.createElement('div');
          overlay.classList.add('overlay');

          const highlightedImage = document.createElement('img');
          highlightedImage.src = (mode === 'generate') ? "https://img.craiyon.com/" + url[0] : "https://pics.craiyon.com/" + url[0];
          highlightedImage.classList.add('highlighted-image');

          const buttonContainer = document.createElement('div');
          buttonContainer.style.position = 'fixed';
          buttonContainer.style.top = '50%';
          buttonContainer.style.right = '0';
          buttonContainer.style.transform = 'translateY(-50%)';
          buttonContainer.style.zIndex = '9999';
          buttonContainer.style.display = 'flex';
          buttonContainer.style.flexDirection = 'column';
          buttonContainer.style.alignItems = 'center';

          // const cancelButton = document.createElement('button');
          // cancelButton.innerText = 'Cancel';
          // cancelButton.className = 'CancelButton';
          // cancelButton.style.marginBottom = '10px';
          overlay.addEventListener('click', () => {
            document.body.removeChild(overlay);
            document.body.removeChild(buttonContainer);
          });

          const downloadButton = document.createElement('a');
          downloadButton.innerText = 'Download';
          downloadButton.className = 'CancelButton';
          downloadButton.addEventListener('click', () => {
            downloadImage(highlightedImage.src);
          });


          // buttonContainer.appendChild(cancelButton);
          buttonContainer.appendChild(downloadButton);

          overlay.appendChild(highlightedImage);
          overlay.appendChild(buttonContainer);
          document.body.appendChild(overlay);
        });
      }

      upgradeIcon.addEventListener('click', () =>{image.click()})
      // Add hover effect 
      gridItem.addEventListener('mouseenter', () => {
        image.style.filter = 'brightness(70%)';
        image.style.transform = 'scale(1.05)';
      });

      gridItem.addEventListener('mouseleave', () => {
        image.style.filter = '';
        image.style.transform = '';
      });

      gridItem.appendChild(image);
      gridItem.appendChild(span);
      gridItem.appendChild(upgradeIcon);

      return gridItem;
    }

    function Delete() {
      const generateButton = document.getElementById('generateButton');
      const upscaleButton = document.getElementById('upscaleButton');

      fetch(currentURL + '/delete', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({mode:mode})
      })
      .then(response => response.json())
      .then(data => 
        showPopup(data)
      )
      .catch(error => {
        console.error('Error:', error);
      });
    }

    function showToast(message) {
      const toastContainer = document.getElementById('toastContainer');
      
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerText = message;
      
      toastContainer.appendChild(toast);

      // Change background color to #4285F4
      // toastContainer.style.backgroundColor = '#4285F4';

      setTimeout(function () {
          toast.classList.add('show');
          setTimeout(function () {
            toast.classList.remove('show');
            setTimeout(function () {
              toast.remove();

              // Revert background color to transparent
              toastContainer.style.backgroundColor = 'transparent';
            }, 300);
          }, 2000);
        }, 300);
      }

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      } 

    async function RepeatCall(){
      if(callTo == ''){return}
      const imageGrid = document.getElementById('image-grid');

      fetch('./'+callTo)
          .then(response => response.json())
          .then(data => {
            if(imageGrid.childElementCount == data.length){
              setTimeout(RepeatCall, 5000);
              return
            }
            imageGrid.innerHTML = '';
            if (Array.isArray(data)) {
              data.reverse().forEach(url => {
                const gridItem = createGridItem(url,mode);
                imageGrid.appendChild(gridItem);
              });
            } else {
              Object.reverse().values(data).forEach(url => {
                const gridItem = createGridItem(url,mode);
                imageGrid.appendChild(gridItem);  
              });
            }
            setTimeout(RepeatCall, 5000);
          })
          .catch(error => {
            console.error('Error:', error);
            setTimeout(RepeatCall, 5000);
          });
    }

    async function DownloadOrUpscale(){
      const imageGrid = document.getElementById('image-grid');
      for (let i = 0; i < imageGrid.children.length; i++) {
        const child = imageGrid.children[i];
        const imgElement = child.querySelector('img');
        if (imgElement.src.includes('pics.craiyon.com')) {
          downloadImage(imgElement.src);
        }
        else{
          imgElement.click()
        }
        await sleep(250);
      }
    }

    function toUpload(){
      window.open(currentURL+'/upload', '_blank');
    }

    function generateUUID() {
      let d = new Date().getTime();
      const uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = (d + Math.random() * 16) % 16 | 0;
        d = Math.floor(d / 16);
        return (c == 'x' ? r : (r & 0x3 | 0x8)).toString(16);
      });
      return uuid;
    }

    // Clear URL query parameters
    function clearURLParams() {
      const newURL = window.location.protocol + "//" + window.location.host + window.location.pathname;
      history.replaceState({}, document.title, newURL);
    }

    // Call the function to clear URL query parameters
    repeatstart = false
    clearURLParams();
    currentURL =  window.location.href;
    toggleMode('generate');
    loadData();
  </script>
</body>
</html>
